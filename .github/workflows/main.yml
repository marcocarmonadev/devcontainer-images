name: CI/CD

on: 
  push:
    branches:
        - main

jobs:
  deploy:
    strategy:
      matrix:
        language: ["python", "go", "node"]
    runs-on: ubuntu-latest
    steps:
        - name: Checkout
          uses: actions/checkout@v4
        - name: Generate .devcontainer.json files
          run: |
            jq \
              -s '.[1].customizations.vscode.extensions += .[0].customizations.vscode.extensions | .[0] * .[1]' \
              -S \
              source/devcontainer.json source/${{ matrix.language }}/devcontainer.json > source/${{ matrix.language }}/.devcontainer.json
        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3
        - name: Login to Docker Hub
          uses: docker/login-action@v3
          with:
            registry: ghcr.io
            username: ${{ github.actor }}
            password: ${{ secrets.GH_TOKEN }}
        - name: Install devcontainer CLI
          run: npm install -g @devcontainers/cli
        - name: Build and push devcontainers/{{ matrix.language }}
          run: |
            devcontainer build \
                --workspace-folder source/${{ matrix.language }} \
                --image-name ghcr.io/${{ github.actor }}/devcontainers/${{ matrix.language }} \
                --cache-from ghcr.io/${{ github.actor }}/devcontainers/${{ matrix.language }} \
                --push true