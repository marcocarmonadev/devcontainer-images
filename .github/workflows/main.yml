name: CI/CD

on: 
  push:
    branches:
        - main

jobs:
  deploy:
    strategy:
      matrix:
        language: ["python", "go", "node"]
    runs-on: ubuntu-latest
    steps:
        - name: Checkout
          uses: actions/checkout@v4
        - name: Generate .devcontainer.{{ variant }}.json files
          run: |
            for variant in $(jq -r '.variants[]' source/${{ matrix.language }}/manifest.json); do
              jq \
              --slurp \
              --sort-keys \
              '.[0] * .[1] * { build: { args: { VARIANT: "'"$variant"'" } } }' \
              source/.devcontainer.json source/${{ matrix.language }}/.devcontainer.json > source/${{ matrix.language }}/.devcontainer.$variant.json;
            done
        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3
        - name: Login to Docker Hub
          uses: docker/login-action@v3
          with:
            registry: ghcr.io
            username: ${{ github.actor }}
            password: ${{ secrets.GH_TOKEN }}
        - name: Install devcontainer CLI
          run: npm install -g @devcontainers/cli
        - name: Build and push devcontainers/{{ matrix.language }}
          run: |
            for variant in $(jq -r '.variants[]' source/${{ matrix.language }}/manifest.json); do
              devcontainer build \
                  --workspace-folder source/${{ matrix.language }} \
                  --config source/${{ matrix.language }}/.devcontainer.$variant.json \
                  --image-name ghcr.io/${{ github.actor }}/devcontainers/${{ matrix.language }}:$variant \
                  --cache-from ghcr.io/${{ github.actor }}/devcontainers/${{ matrix.language }}:$variant \
                  --push true
            done